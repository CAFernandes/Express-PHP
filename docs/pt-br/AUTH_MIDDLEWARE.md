# üîê Middleware de Autentica√ß√£o - Express PHP

## Vis√£o Geral

O Express PHP agora inclui um **middleware de autentica√ß√£o autom√°tica** robusto e flex√≠vel que suporta m√∫ltiplos m√©todos de autentica√ß√£o nativamente:

- ‚úÖ **JWT (JSON Web Tokens)** - com suporte √† biblioteca Firebase ou implementa√ß√£o nativa
- ‚úÖ **Basic Authentication** - autentica√ß√£o HTTP b√°sica
- ‚úÖ **Bearer Token** - tokens personalizados
- ‚úÖ **API Key** - via header ou query parameter
- ‚úÖ **Autentica√ß√£o Customizada** - callback personalizado
- ‚úÖ **M√∫ltiplos M√©todos** - permite v√°rios m√©todos em uma √∫nica configura√ß√£o
- ‚úÖ **Caminhos Exclu√≠dos** - exclui rotas espec√≠ficas da autentica√ß√£o
- ‚úÖ **Modo Flex√≠vel** - autentica√ß√£o opcional

## üöÄ Instala√ß√£o

### Depend√™ncias Opcionais

Para JWT com m√°xima compatibilidade, instale:

```bash
composer require firebase/php-jwt
```

> **Nota:** O Express PHP inclui uma implementa√ß√£o nativa de JWT HS256, ent√£o a biblioteca Firebase √© opcional.

## üìñ Uso B√°sico

### 1. JWT Authentication

```php
use Express\Middlewares\Security\AuthMiddleware;
use Express\Helpers\JWTHelper;

// Configura√ß√£o simples
$app->use(AuthMiddleware::jwt('sua_chave_secreta'));

// Login para obter token
$app->post('/login', function($req, $res) {
    // Validar credenciais...

    $token = JWTHelper::encode([
        'user_id' => $userId,
        'username' => $username,
        'role' => $userRole
    ], 'sua_chave_secreta', [
        'expiresIn' => 3600 // 1 hora
    ]);

    $res->json(['token' => $token]);
});

// Usar: Authorization: Bearer <token>
```

### 2. Basic Authentication

```php
function validateUser($username, $password) {
    // Consultar banco de dados
    $users = ['admin' => 'senha123'];

    return isset($users[$username]) && $users[$username] === $password
        ? ['id' => 1, 'username' => $username] : false;
}

$app->use(AuthMiddleware::basic('validateUser'));

// Usar: Authorization: Basic <base64(username:password)>
```

### 3. API Key Authentication

```php
function validateApiKey($key) {
    $validKeys = [
        'key123456' => ['name' => 'App Mobile', 'permissions' => ['read', 'write']],
        'service_key' => ['name' => 'Integration', 'permissions' => ['read']]
    ];

    return $validKeys[$key] ?? false;
}

$app->use(AuthMiddleware::apiKey('validateApiKey'));

// Usar: X-API-Key: key123456 OU ?api_key=key123456
```

### 4. M√∫ltiplos M√©todos

```php
$app->use(new AuthMiddleware([
    'authMethods' => ['jwt', 'basic', 'apikey'],
    'jwtSecret' => getenv('JWT_SECRET'),
    'basicAuthCallback' => 'validateUser',
    'apiKeyCallback' => 'validateApiKey',
    'allowMultiple' => true,
    'excludePaths' => ['/public', '/login', '/docs']
]));
```

## üõ†Ô∏è Configura√ß√µes Avan√ßadas

### Configura√ß√£o Completa

```php
$app->use(new AuthMiddleware([
    // M√©todos de autentica√ß√£o suportados
    'authMethods' => ['jwt', 'basic', 'bearer', 'apikey', 'custom'],

    // Configura√ß√µes JWT
    'jwtSecret' => 'sua_chave_jwt_super_secreta',
    'jwtAlgorithm' => 'HS256',

    // Callbacks de valida√ß√£o
    'basicAuthCallback' => 'validateBasicAuth',
    'bearerTokenCallback' => 'validateBearerToken',
    'apiKeyCallback' => 'validateApiKey',
    'customAuthCallback' => 'customAuthentication',

    // Configura√ß√µes de API Key
    'headerName' => 'X-API-Key',
    'queryParam' => 'api_key',

    // Comportamento
    'requireAuth' => true,
    'allowMultiple' => false,
    'userProperty' => 'user', // $req->user

    // Caminhos exclu√≠dos
    'excludePaths' => ['/health', '/docs', '/public'],

    // Mensagens personalizadas
    'errorMessages' => [
        'missing' => 'Autentica√ß√£o requerida',
        'invalid' => 'Credenciais inv√°lidas',
        'expired' => 'Token expirado'
    ]
]));
```

### Autentica√ß√£o por Rota

```php
// Rota espec√≠fica com JWT
$app->get('/admin/users',
    AuthMiddleware::jwt('chave_secreta'),
    function($req, $res) {
        // Apenas usu√°rios com JWT v√°lido
        $res->json(['users' => [...], 'admin' => $req->user]);
    }
);

// Rota espec√≠fica com API Key
$app->get('/api/data',
    AuthMiddleware::apiKey('validateApiKey'),
    function($req, $res) {
        // Apenas clientes com API Key v√°lida
        $res->json(['data' => [...], 'client' => $req->user]);
    }
);
```

### Modo Flex√≠vel (Autentica√ß√£o Opcional)

```php
$app->use(AuthMiddleware::flexible([
    'authMethods' => ['jwt', 'apikey'],
    'jwtSecret' => 'chave_secreta',
    'apiKeyCallback' => 'validateApiKey'
]));

$app->get('/mixed', function($req, $res) {
    if (isset($req->auth) && $req->auth['authenticated']) {
        // Usu√°rio autenticado
        $message = "Ol√°, " . $req->user['username'];
    } else {
        // Usu√°rio an√¥nimo
        $message = "Ol√°, visitante";
    }

    $res->json(['message' => $message]);
});
```

## üîß JWTHelper - Utilit√°rio JWT

### M√©todos Principais

```php
use Express\Helpers\JWTHelper;

// Gerar token
$token = JWTHelper::encode($payload, $secret, $options);

// Validar token
$isValid = JWTHelper::isValid($token, $secret);

// Decodificar token
$payload = JWTHelper::decode($token, $secret);

// Verificar expira√ß√£o
$isExpired = JWTHelper::isExpired($token, $leeway);

// Gerar chave secreta
$secret = JWTHelper::generateSecret(32);

// Refresh tokens
$refreshToken = JWTHelper::createRefreshToken($userId, $secret);
$refreshData = JWTHelper::validateRefreshToken($refreshToken, $secret);
```

### Sistema de Refresh Token

```php
// Login com refresh token
$app->post('/login', function($req, $res) {
    // Validar credenciais...

    $accessToken = JWTHelper::encode([
        'user_id' => $userId
    ], 'jwt_secret', ['expiresIn' => 900]); // 15 min

    $refreshToken = JWTHelper::createRefreshToken(
        $userId,
        'refresh_secret'
    ); // 30 dias

    $res->json([
        'access_token' => $accessToken,
        'refresh_token' => $refreshToken,
        'expires_in' => 900
    ]);
});

// Renovar token
$app->post('/refresh', function($req, $res) {
    $refreshToken = $req->body['refresh_token'];
    $payload = JWTHelper::validateRefreshToken($refreshToken, 'refresh_secret');

    if ($payload) {
        $newToken = JWTHelper::encode([
            'user_id' => $payload['user_id']
        ], 'jwt_secret');

        $res->json(['access_token' => $newToken]);
    } else {
        $res->status(401)->json(['error' => 'Invalid refresh token']);
    }
});
```

## üìä Acessando Dados do Usu√°rio

Ap√≥s autentica√ß√£o bem-sucedida:

```php
$app->get('/profile', function($req, $res) {
    // Dados do usu√°rio autenticado
    $user = $req->user;

    // Informa√ß√µes da autentica√ß√£o
    $authMethod = $req->auth['method']; // 'jwt', 'basic', 'apikey', etc.
    $authenticated = $req->auth['authenticated']; // true

    $res->json([
        'user' => $user,
        'auth_method' => $authMethod,
        'message' => "Ol√°, {$user['username']}"
    ]);
});
```

## üîí Valida√ß√£o de Roles e Permiss√µes

```php
// Middleware para verificar role de admin
function requireAdmin($req, $res, $next) {
    if (!$req->user || $req->user['role'] !== 'admin') {
        $res->status(403)->json(['error' => 'Admin role required']);
        return;
    }
    $next();
}

// Middleware para verificar permiss√µes espec√≠ficas
function requirePermission($permission) {
    return function($req, $res, $next) use ($permission) {
        $userPermissions = $req->user['permissions'] ?? [];

        if (!in_array($permission, $userPermissions)) {
            $res->status(403)->json(['error' => "Permission '{$permission}' required"]);
            return;
        }

        $next();
    };
}

// Usar em rotas
$app->get('/admin/panel',
    AuthMiddleware::jwt('chave_secreta'),
    'requireAdmin',
    function($req, $res) {
        $res->json(['message' => 'Admin panel']);
    }
);

$app->delete('/api/data/:id',
    AuthMiddleware::apiKey('validateApiKey'),
    requirePermission('delete'),
    function($req, $res) {
        // Apenas usu√°rios com permiss√£o 'delete'
        $res->json(['message' => 'Data deleted']);
    }
);
```

## üß™ Testando

### cURL Examples

```bash
# JWT
curl -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..." \
     http://localhost/api/protected

# Basic Auth
curl -u admin:password123 \
     http://localhost/api/protected

# API Key (Header)
curl -H "X-API-Key: key123456" \
     http://localhost/api/protected

# API Key (Query)
curl "http://localhost/api/protected?api_key=key123456"
```

### Executar Testes

```bash
# Teste completo de autentica√ß√£o
composer test:auth

# Ou diretamente
php test/auth_test.php

# Testes unit√°rios
./vendor/bin/phpunit tests/Security/AuthMiddlewareTest.php
./vendor/bin/phpunit tests/Helpers/JWTHelperTest.php
```

## üìã Exemplos Completos

- **Exemplo b√°sico:** [`examples/example_auth.php`](../../examples/example_auth.php)
- **Snippets r√°pidos:** [`examples/snippets/auth_snippets.php`](examples/snippets/auth_snippets.php)

## üîß Configura√ß√£o de Produ√ß√£o

### Vari√°veis de Ambiente

```env
JWT_SECRET=sua_chave_jwt_super_secreta_em_producao
REFRESH_SECRET=sua_chave_refresh_super_secreta
JWT_EXPIRE_TIME=3600
REFRESH_EXPIRE_TIME=2592000
```

### Configura√ß√£o Recomendada

```php
$app->use(new AuthMiddleware([
    'authMethods' => ['jwt', 'apikey'],
    'jwtSecret' => getenv('JWT_SECRET'),
    'apiKeyCallback' => 'validateApiKey',
    'excludePaths' => ['/health', '/docs'],
    'requireAuth' => true,
    'allowMultiple' => false,
    'errorMessages' => [
        'missing' => 'Access token required',
        'invalid' => 'Invalid authentication credentials',
        'expired' => 'Authentication token expired'
    ]
]));
```

## üí° Dicas de Seguran√ßa

1. **Sempre use HTTPS em produ√ß√£o**
2. **Use chaves secretas fortes e aleat√≥rias**
3. **Configure tokens com tempo de expira√ß√£o apropriado**
4. **Implemente refresh tokens para sess√µes longas**
5. **Valide permiss√µes espec√≠ficas al√©m da autentica√ß√£o**
6. **Use rate limiting em rotas de login**
7. **Monitore tentativas de acesso inv√°lidas**

---

## üÜï Novos Recursos

### ‚ú® Implementados

- ‚úÖ Middleware de autentica√ß√£o autom√°tica com m√∫ltiplos m√©todos
- ‚úÖ Helper JWT com implementa√ß√£o nativa HS256
- ‚úÖ Suporte a Firebase JWT (opcional)
- ‚úÖ Autentica√ß√£o Basic Auth
- ‚úÖ Autentica√ß√£o Bearer Token
- ‚úÖ Autentica√ß√£o API Key (header/query)
- ‚úÖ Autentica√ß√£o customizada via callback
- ‚úÖ Sistema de refresh tokens
- ‚úÖ Caminhos exclu√≠dos configur√°veis
- ‚úÖ Modo flex√≠vel (autentica√ß√£o opcional)
- ‚úÖ Mensagens de erro customiz√°veis
- ‚úÖ Testes unit√°rios completos
- ‚úÖ Documenta√ß√£o abrangente
- ‚úÖ Exemplos pr√°ticos

### üîÑ Compatibilidade

O novo middleware √© totalmente compat√≠vel com a estrutura existente do Express PHP e n√£o quebra nenhuma funcionalidade anterior.

---

**Express PHP** - Microframework moderno e seguro para APIs PHP! üöÄ
